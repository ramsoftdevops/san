pipeline {
    agent { label 'docker-maven-trivy' }
     tools {
    maven 'maven3'
      }
     environment {
    SONAR_IP = '34.226.203.50'
    ECR_REGISTRY = '773195032411.dkr.ecr.us-east-1.amazonaws.com'
  }  
    stages {
        stage('Build') {
            steps {
                sh 'echo "hello"'
            }
        }
        stage('trivyfsscan'){
         steps {
             sh 'trivy fs --exit-code 1 --severity HIGH,CRITICAL .'
           }
        }
        stage('Build & Sonar') {
      steps {
         dir('java-maven') {
        withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
          sh 'mvn clean verify sonar:sonar \
  -Dsonar.projectKey=cwvj-devsecops-demo \
  -Dsonar.host.url="http://${SONAR_IP}:9000" \
  -Dsonar.token="${SONAR_TOKEN}" \
  -Dsonar.qualitygate.wait=true'
        }
      }
    }
}
 stage('ECR Login') {
      steps {
        sh 'aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin $ECR_REGISTRY'
      }
    }
}
}